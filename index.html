<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Schedule</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --danger: #cf6679;
            --success: #03dac6;
            --warning: #ff5252;
            --secondary: #333;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }

        #alert-box {
            position: fixed; top: 20px; right: 20px;
            background: var(--warning); color: white;
            padding: 20px; border-radius: 12px; font-weight: bold;
            display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            border: 2px solid white; max-width: 300px;
        }
        #alert-box.clickable { cursor: pointer; }

        .container { width: 100%; max-width: 1200px; }

        .manager-section {
            background: var(--card); padding: 20px; border-radius: 12px;
            border: 1px solid var(--secondary); margin-bottom: 30px;
        }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }

        button {
            padding: 10px 15px; border: none; border-radius: 6px;
            cursor: pointer; background: var(--accent); color: #000; font-weight: bold;
            display: inline-flex; align-items: center; gap: 5px;
        }
        button.secondary { background: var(--secondary); color: white; }
        button.danger { background: var(--danger); color: white; }

        input, select, textarea { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; }

        .week-container { border: 2px solid var(--secondary); border-radius: 12px; padding: 20px; margin-bottom: 40px; }
        .week-container.active-week { border-color: var(--success); background: #131a18; }

        .days-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .day-card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--secondary); }

        .lesson-item {
            background: #2d2d2d; padding: 12px; border-radius: 8px; margin-top: 10px;
            font-size: 0.9em; border-left: 4px solid var(--accent); position: relative;
        }
        .lesson-item.upcoming { background: #441a1a; border-left-color: var(--warning); animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(255, 82, 82, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { box-shadow: 0 0 0 0px rgba(255, 82, 82, 0); }
        }

        .utility-links { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px; }
        .utility-links a { font-size: 0.75em; background: #444; color: #ddd; padding: 2px 6px; border-radius: 4px; text-decoration: none; }

        .remove-btn { position: absolute; top: 5px; right: 8px; color: #888; cursor: pointer; }
        .input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; }
        .location-tag { font-size: 0.85em; color: var(--accent); font-weight: bold; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div id="alert-box"></div>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 id="title-main">üóìÔ∏è Lesson Schedule</h1>
        <button onclick="toggleLang()" class="secondary" id="lang-btn">üá∫üá¶ UA / üá∫üá∏ EN</button>
    </div>

    <section class="manager-section">
        <h3 id="t-manager-title">üõ†Ô∏è Lesson Templates</h3>
        <div class="input-group" style="flex-direction: row; flex-wrap: wrap; border: none;">
            <input type="text" id="t-name" placeholder="Subject">
            <input type="text" id="t-teacher" placeholder="Teacher">
            <input type="url" id="t-main" placeholder="Main Link">
            <input type="text" id="t-extra" placeholder="Extra Links">
            <button onclick="addTemplate()" id="save-t-btn">Save Template</button>
        </div>
        <div id="template-list" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;"></div>
    </section>

    <div class="controls">
        <button onclick="addWeek()" id="add-week-btn">+ Add Week</button>
        <button class="secondary" onclick="exportToFile()" id="btn-save-file">üíæ Save to File</button>
        <button class="secondary" onclick="document.getElementById('file-input').click()" id="btn-load-file">üìÇ Load File</button>
        <button class="danger" onclick="resetToDefault()" id="btn-reset">üîÑ Reset to Default</button>
        <input type="file" id="file-input" accept=".json" onchange="importFromFile(event)">
        
        <div style="flex-grow: 1; display: flex; gap: 5px;">
            <input type="text" id="import-box" placeholder="Paste export code..." style="flex-grow: 1;">
            <button class="secondary" onclick="importData()" id="import-btn">üì• Import</button>
        </div>
    </div>

    <div id="weeks-display"></div>
</div>

<script>
    const CONFIG = {
        DEFAULT_FILE: 'default_schedule.json',
        STORAGE_KEY: 'lessonScheduleV10'
    };

    const i18n = {
        en: {
            title: "üóìÔ∏è Lesson Schedule", t_title: "üõ†Ô∏è Lesson Templates",
            subject: "Subject", teacher: "Teacher", main_l: "Main Link", extra_l: "Extra Links",
            save_t: "Save Template", add_w: "+ Add New Week", export: "üìã Export", import: "Import",
            save_f: "üíæ Save to File", load_f: "üìÇ Load File", reset: "üîÑ Reset to Default",
            set_curr: "Set as Current", del_w: "Delete Week", add_to_day: "+ Add to Day",
            sel_sub: "-- Select Subject --", click_join: "CLICK TO JOIN", soon: "SOON:",
            location: "Location", loc_label: "Loc:", confirm_reset: "Wipe all current data and overwrite with 'default_schedule.json'?",
            days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
        },
        ua: {
            title: "üóìÔ∏è –†–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å", t_title: "üõ†Ô∏è –®–∞–±–ª–æ–Ω–∏ –∑–∞–Ω—è—Ç—å",
            subject: "–ü—Ä–µ–¥–º–µ—Ç", teacher: "–í–∏–∫–ª–∞–¥–∞—á", main_l: "–û—Å–Ω–æ–≤–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è", extra_l: "–î–æ–¥. –ø–æ—Å–∏–ª–∞–Ω–Ω—è",
            save_t: "–ó–±–µ—Ä–µ–≥—Ç–∏ —à–∞–±–ª–æ–Ω", add_w: "+ –î–æ–¥–∞—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å", export: "üìã –ï–∫—Å–ø–æ—Ä—Ç", import: "–Ü–º–ø–æ—Ä—Ç",
            save_f: "üíæ –ó–±–µ—Ä–µ–≥—Ç–∏", load_f: "üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏", reset: "üîÑ –°–∫–∏–Ω—É—Ç–∏ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö",
            set_curr: "–ó—Ä–æ–±–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–º", del_w: "–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å", add_to_day: "+ –î–æ–¥–∞—Ç–∏ –≤ –¥–µ–Ω—å",
            sel_sub: "-- –û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–¥–º–µ—Ç --", click_join: "–ù–ê–¢–ò–°–ù–Ü–¢–¨, –©–û–ë –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø", soon: "–°–ö–û–†–û:",
            location: "–ú—ñ—Å—Ü–µ", loc_label: "–ú—ñ—Å—Ü–µ:", confirm_reset: "–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ 'default_schedule.json'?",
            days: ["–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü'—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞", "–ù–µ–¥—ñ–ª—è"]
        }
    };

    let data = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY));

    const map = {
        templates: 't', weeks: 'w', currentWeekIndex: 'c', cycleStartDate: 's', lang: 'l',
        id: 'i', name: 'n', teacher: 'tr', main: 'm', extra: 'e',
        dayNameEn: 'de', dayNameUa: 'du', lessons: 'ls',
        templateId: 'ti', start: 'st', end: 'en', location: 'lo'
    };
    const reverseMap = Object.fromEntries(Object.entries(map).map(([k, v]) => [v, k]));

    function transform(obj, m) {
        if (Array.isArray(obj)) return obj.map(v => transform(v, m));
        if (obj !== null && typeof obj === 'object') {
            return Object.fromEntries(Object.entries(obj).map(([k, v]) => [m[k] || k, transform(v, m)]));
        }
        return obj;
    }

    async function loadDefaultFromFile() {
        try {
            const response = await fetch(CONFIG.DEFAULT_FILE);
            if (!response.ok) throw new Error("Default file not found");
            const defaultData = await response.json();
            data = defaultData;
            save(); // Overwrites local storage
            alert(data.lang === 'en' ? "Successfully reset to default!" : "–£—Å–ø—ñ—à–Ω–æ —Å–∫–∏–Ω—É—Ç–æ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö!");
        } catch (err) {
            console.warn("Could not find default_schedule.json. Initializing empty.");
            if (!data) {
                data = { templates: [], weeks: [], currentWeekIndex: 0, cycleStartDate: Date.now(), lang: 'en' };
                save();
            }
        }
    }

    function resetToDefault() {
        if (confirm(t('confirm_reset'))) {
            loadDefaultFromFile();
        }
    }

    if (!data) { loadDefaultFromFile(); }

    function t(key) { return i18n[data.lang][key]; }
    function save() { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data)); render(); }
    function toggleLang() { data.lang = data.lang === 'en' ? 'ua' : 'en'; save(); }

    function exportToFile() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `schedule-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imp = JSON.parse(ev.target.result);
                if (imp.weeks) { data = imp; save(); }
            } catch (err) { alert("Invalid File"); }
        };
        reader.readAsText(file);
    }

    function importData() {
        try {
            const input = document.getElementById('import-box').value.trim();
            let decoded = input.startsWith('{') ? JSON.parse(input) : transform(JSON.parse(decodeURIComponent(escape(atob(input)))), reverseMap);
            if(decoded.weeks) { data = decoded; save(); document.getElementById('import-box').value = ""; }
        } catch(e) { alert("Error"); }
    }

    function getAdjustedWeekIndex() {
        if (!data || data.weeks.length === 0) return 0;
        const elapsed = Math.floor((Date.now() - data.cycleStartDate) / 604800000);
        return (data.currentWeekIndex + elapsed) % data.weeks.length;
    }

    function addTemplate() {
        const n = document.getElementById('t-name').value, tr = document.getElementById('t-teacher').value;
        if(!n || !tr) return;
        data.templates.push({ id: Date.now(), name: n, teacher: tr, main: document.getElementById('t-main').value, extra: document.getElementById('t-extra').value.split(',').filter(x=>x) });
        save();
    }

    function addScheduledLesson(wIdx, dIdx, btn) {
        const g = btn.closest('.input-group');
        const tid = parseInt(g.querySelector('.t-select').value);
        if(!tid) return;
        data.weeks[wIdx][dIdx].lessons.push({ id: Date.now(), templateId: tid, start: g.querySelector('.t-start').value, end: g.querySelector('.t-end').value, location: g.querySelector('.t-location').value });
        save();
    }

    function checkAlerts() {
        if (!data) return;
        const now = new Date();
        const curMin = now.getHours() * 60 + now.getMinutes();
        const week = data.weeks[getAdjustedWeekIndex()];
        if(!week) return;
        let dIdx = now.getDay() - 1; if(dIdx === -1) dIdx = 6;
        const today = week[dIdx].lessons;
        let upcoming = null;

        document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('upcoming'));
        today.forEach(sl => {
            const [h, m] = sl.start.split(':').map(Number);
            const diff = (h * 60 + m) - curMin;
            if(diff > 0 && diff <= 30) {
                const tmp = data.templates.find(t => t.id === sl.templateId);
                if(tmp) {
                    upcoming = { ...sl, ...tmp };
                    const el = document.getElementById(`l-${sl.id}`);
                    if(el) { el.classList.add('upcoming'); if(tmp.main) el.onclick = () => window.open(tmp.main, '_blank'); }
                }
            }
        });
        const box = document.getElementById('alert-box');
        if(upcoming) {
            box.innerHTML = `<div style='font-size:0.7em'>${t('click_join')}</div><div>${t('soon')} ${upcoming.name}</div><div style='font-size:0.8em'>${upcoming.start} | ${upcoming.location || '---'}</div>`;
            box.style.display = 'block';
            if(upcoming.main) { box.className = 'clickable'; box.onclick = () => window.open(upcoming.main, '_blank'); }
        } else { box.style.display = 'none'; }
    }

    function render() {
        if (!data) return;
        const lang = data.lang;
        
        // Dynamic Label Updating
        const ids = ['title-main','t-manager-title','save-t-btn','add-week-btn','btn-save-file','btn-load-file','btn-reset','import-btn'];
        ids.forEach(id => {
            let key = id.replace('btn-','').replace('-btn','').replace('title-','').replace('-title','').replace('save-t','save_t').replace('add-week','add_w');
            if (i18n[lang][key]) document.getElementById(id).innerText = i18n[lang][key];
        });
        
        document.getElementById('t-name').placeholder = t('subject');
        document.getElementById('t-teacher').placeholder = t('teacher');
        document.getElementById('t-main').placeholder = t('main_l');
        document.getElementById('t-extra').placeholder = t('extra_l');

        document.getElementById('template-list').innerHTML = data.templates.map(tmp => `
            <div style="background:#252525; padding:8px 12px; border-radius:20px; border:1px solid #444; position:relative;">
                <span style="font-size:0.9em"><b>${tmp.name}</b></span>
                <span class="remove-btn" style="position:static; margin-left:10px;" onclick="data.templates = data.templates.filter(t => t.id !== ${tmp.id}); save();">&times;</span>
            </div>
        `).join('');

        const activeIdx = getAdjustedWeekIndex();
        document.getElementById('weeks-display').innerHTML = data.weeks.map((week, wIdx) => {
            const isActive = activeIdx === wIdx;
            return `
            <div class="week-container ${isActive ? 'active-week' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0">Week ${wIdx + 1} ${isActive ? 'üü¢' : ''}</h2>
                    <div>
                        <button class="secondary" onclick="data.currentWeekIndex=${wIdx}; data.cycleStartDate=Date.now(); save();">${t('set_curr')}</button>
                        <button class="danger" onclick="if(confirm('Delete week?')) { data.weeks.splice(${wIdx},1); save(); }">&times;</button>
                    </div>
                </div>
                <div class="days-grid">${week.map((day, dIdx) => `
                    <div class="day-card">
                        <h3 style="margin-top:0">${lang === 'en' ? day.dayNameEn : day.dayNameUa}</h3>
                        <div>${day.lessons.map(sl => {
                            const tmp = data.templates.find(tm => tm.id === sl.templateId) || {name: '?'};
                            return `<div class="lesson-item" id="l-${sl.id}">
                                <div class="remove-btn" onclick="data.weeks[${wIdx}][${dIdx}].lessons = data.weeks[${wIdx}][${dIdx}].lessons.filter(l => l.id !== ${sl.id}); save(); event.stopPropagation();">&times;</div>
                                <b>${sl.start} - ${sl.end}</b><br>${tmp.name}<br>
                                <span class="location-tag">${t('loc_label')} ${sl.location || '---'}</span>
                            </div>`;
                        }).join('')}</div>
                        <div class="input-group">
                            <select class="t-select"><option value="">${t('sel_sub')}</option>${data.templates.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('')}</select>
                            <input type="time" class="t-start">
                            <input type="text" class="t-location" placeholder="${t('location')}">
                            <button onclick="addScheduledLesson(${wIdx},${dIdx},this)">${t('add_to_day')}</button>
                        </div>
                    </div>
                `).join('')}</div>
            </div>`;
        }).join('');
    }

    setInterval(checkAlerts, 10000);
    render();
</script>
</body>
</html>